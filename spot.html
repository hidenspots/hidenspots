<!doctype html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-DWS0BB3H70"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-DWS0BB3H70');
  </script>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Spot â€¢ Hiden Spots</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0c0f18; --panel:#121624; --glass:rgba(255,255,255,.06);
      --border:rgba(255,255,255,.12); --muted:rgba(255,255,255,.78);
      --gold:#FFD88D; --amber:#FFB347; --teal:#19547b;
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0}
    body{
      background:var(--bg); color:#fff; font-family:'Playfair Display',serif;
      overflow:hidden; /* Prevent page scroll when swiping */
    }
    /* Header */
    .header{
      position:sticky; top:0; z-index:40;
      backdrop-filter:blur(12px);
      background:linear-gradient(180deg,rgba(12,15,24,.85),rgba(12,15,24,.55));
      border-bottom:1px solid var(--border);
      padding:12px 18px;
      display:flex; align-items:center; gap:14px;
    }
    .brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:#fff}
    .brand svg{width:30px;height:30px}
    .brand span{letter-spacing:3px}
    /* Main Spot Card */
    .main{
      height:100vh;
      position:relative;
      overflow:hidden;
    }
    .spot-card{
      position:absolute;
      inset:0;
      background:var(--panel);
      border-radius:0;
      overflow:hidden;
      box-shadow:0 0 40px rgba(0,0,0,0.6);
      transition:transform 0.6s ease, opacity 0.6s ease;
      opacity:0;
      transform:scale(0.9) translateY(50px);
      pointer-events:none;
    }
    .spot-card.active{
      opacity:1;
      transform:scale(1) translateY(0);
      pointer-events:auto;
      z-index:10;
    }
    .spot-card.next{
      transform:scale(0.95) translateY(30px);
      opacity:0.7;
      z-index:5;
    }
    .spot-card.prev{
      transform:scale(0.95) translateY(-30px);
      opacity:0.7;
      z-index:5;
    }
    /* Hero Media */
    .hero-media {
      width: 100%;
      height: 70vh;
      overflow: hidden;
    }
    .hero-media img,
    .hero-media video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    /* Info Overlay */
    .info-overlay{
      position:absolute;
      bottom:0;
      left:0;
      right:0;
      background:linear-gradient(to top, rgba(0,0,0,0.9), transparent);
      padding:2rem 1.5rem 4rem;
      color:#fff;
    }
    .title{
      color:var(--gold);
      font-size:2.2rem;
      margin:0 0 0.5rem;
    }
    .sub{
      font-size:1.2rem;
      opacity:0.9;
      margin:0 0 1rem;
    }
    .story{
      font-size:1.1rem;
      line-height:1.5;
      opacity:0.95;
      max-height:120px;
      overflow:hidden;
    }
    /* Swipe Buttons */
    .swipe-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0,0,0,0.6);
      color: #FFD88D;
      border: none;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      font-size: 2rem;
      cursor: pointer;
      z-index: 20;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .swipe-btn:hover {
      background: rgba(255,216,141,0.4);
      transform: translateY(-50%) scale(1.1);
    }
    .swipe-btn.prev {
      left: 20px;
    }
    .swipe-btn.next {
      right: 20px;
    }
    @media (max-width: 768px) {
      .swipe-btn {
        width: 50px;
        height: 50px;
        font-size: 1.8rem;
      }
    }
    /* Bottom Nav Bar */
    .nav-bar{
      background:rgba(255,255,255,.05);
      backdrop-filter:blur(25px);
      border-radius:60px;
      padding:1rem 2.5rem;
      border:1px solid rgba(255,255,255,.12);
      position:fixed;
      bottom:1rem;left:50%;transform:translateX(-50%);
      display:flex;gap:3rem;
      box-shadow:0 8px 30px rgba(0,0,0,.25);
      z-index:80;
    }
    .nav-icon{color:rgba(255,255,255,.7);transition:.4s}
    .nav-icon:hover{color:#FFD88D;transform:translateY(-2px);filter:drop-shadow(0 0 10px rgba(255,216,155,.6))}
    .nav-icon svg{width:24px;height:24px;stroke:currentColor;stroke-width:1.8;fill:none}
    @media(max-width:768px){
      .nav-bar{gap:2rem;padding:.9rem 1.6rem}
    }
  </style>
</head>
<body>
<div class="header">
  <a href="index.html" class="brand" aria-label="Hiden Spots">
    <svg viewBox="0 0 48 48" aria-hidden="true">
      <circle cx="24" cy="24" r="21" stroke="rgba(255,255,255,0.85)" stroke-width="1.5"/>
      <path d="M24 10 L28 24 L24 38 L20 24 Z" fill="rgba(255,216,155,0.9)"/>
      <circle cx="24" cy="24" r="2.6" fill="#ffffff"/>
    </svg>
    <span>Hiden Spots</span>
  </a>
</div>

<div class="main" id="main">
  <!-- Cards will be inserted here dynamically -->
</div>

<!-- Bottom Navigation Bar -->
<nav class="nav-bar" aria-label="Primary">
  <a href="Mainhome.html" class="nav-icon" title="Home">
    <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
  </a>
  <a href="Home.html" class="nav-icon" title="Search">
    <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
  </a>
  <a href="Upload.html" class="nav-icon" title="Create">
    <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
  </a>
  <a href="Explore.html" class="nav-icon" title="Destiny List">
    <svg viewBox="0 0 24 24">
      <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/>
      <circle cx="12" cy="9" r="2.5" fill="none"/>
      <path d="M12 6l.9 1.8 2 .3-1.5 1.5.35 2.1L12 11l-1.75.7.35-2.1-1.5-1.5 2-.3L12 6z" fill="currentColor"/>
    </svg>
  </a>
  <a href="Profile.html" class="nav-icon" title="Profile">
    <svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
  </a>
</nav>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const sb = supabase.createClient(
  "https://bhktkjegansxplpdtack.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJoa3RramVnYW5zeHBscGR0YWNrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2OTE2NjQsImV4cCI6MjA4MTI2NzY2NH0.WlQTPkC6WBjaK_Guy0_XPGahR9oNYsbIHdaBn4WQspE"
);
const WORKER_URL = 'https://hiden-spots-r2-proxy.whynot555x7.workers.dev';
const urlParams = new URLSearchParams(window.location.search);
const spotId = urlParams.get('id');

let spot = null; // Global current spot
let relatedSpots = []; // All similar spots
let currentIndex = 0; // Current displayed spot index

if (!spotId) {
  document.body.innerHTML = '<h1 style="text-align:center;margin-top:100px;">No spot selected</h1>';
} else {
  loadSpot(spotId);
}

async function loadSpot(id) {
  const { data, error } = await sb
    .from('spots')
    .select('*')
    .eq('id', id)
    .single();

  if (error || !data) {
    document.body.innerHTML = '<h1 style="text-align:center;margin-top:100px;">Spot not found</h1>';
    return;
  }

  spot = data;
  currentIndex = 0;

  // Load related spots (same category/emotion/city)
  await loadRelatedSpots();

  // Show first card
  renderCards();
}

async function loadRelatedSpots() {
  if (!spot || !spot.category_id || !spot.emotion_id || !spot.city) return;

  const { data, error } = await sb
    .from('spots')
    .select('id, name, place, city, media_url, media_urls, story, category_id, emotion_id')
    .neq('id', spot.id)
    .or(`category_id.eq.${spot.category_id},emotion_id.eq.${spot.emotion_id},city.eq.${spot.city}`);

  if (error || !data) {
    console.error('Failed to load related spots', error);
    return;
  }

  // Include current spot as first card
  relatedSpots = [spot, ...data];
}

function renderCards() {
  const main = document.getElementById('main');
  main.innerHTML = ''; // Clear previous cards

  relatedSpots.forEach((s, index) => {
    const card = document.createElement('div');
    card.className = 'spot-card';
    if (index === currentIndex) card.classList.add('active');
    else if (index === currentIndex + 1) card.classList.add('next');
    else if (index === currentIndex - 1) card.classList.add('prev');

    const firstMedia = s.media_urls?.[0]?.url || s.media_url || 'https://via.placeholder.com/800x1200/141824/FFD88D?text=No+Image';

    card.innerHTML = `
      <div class="hero-media">
        <img src="${firstMedia}" alt="${s.name}" style="width:100%;height:100%;object-fit:cover;" onerror="this.src='https://via.placeholder.com/800x1200/141824/FFD88D?text=No+Image'">
      </div>
      <div class="info-overlay">
        <h1 class="title">${s.name}</h1>
        <p class="sub">${s.place || ''}, ${s.city}</p>
        <p class="story">${s.story?.substring(0, 150) || 'No story'}...</p>
      </div>
    `;

    card.onclick = () => {
      // Optional: tap to view full details
      window.location.href = `spot.html?id=${s.id}`;
    };

    main.appendChild(card);
  });

  // Attach swipe & buttons after cards are rendered
  initSwipe();
}

function initSwipe() {
  const main = document.getElementById('main');
  let isDragging = false;
  let startX;
  let direction = 0; // 1 = right swipe (next), -1 = left swipe (prev)

  main.addEventListener('mousedown', (e) => {
    isDragging = true;
    startX = e.pageX;
  });

  main.addEventListener('mousemove', (e) => {
    if (!isDragging) return;
    const diff = e.pageX - startX;
    direction = diff > 0 ? -1 : 1; // right swipe = negative diff
  });

  main.addEventListener('mouseup', () => {
    if (!isDragging) return;
    isDragging = false;
    if (Math.abs(direction) > 50) { // minimum swipe distance
      changeSpot(direction);
    }
  });

  // Touch events
  main.addEventListener('touchstart', (e) => {
    isDragging = true;
    startX = e.touches[0].pageX;
  }, { passive: false });

  main.addEventListener('touchmove', (e) => {
    if (!isDragging) return;
    const diff = e.touches[0].pageX - startX;
    direction = diff > 0 ? -1 : 1;
  }, { passive: false });

  main.addEventListener('touchend', () => {
    if (!isDragging) return;
    isDragging = false;
    if (Math.abs(direction) > 50) {
      changeSpot(direction);
    }
  }, { passive: false });

  // Arrow buttons
  document.getElementById('prevBtn').onclick = () => changeSpot(-1);
  document.getElementById('nextBtn').onclick = () => changeSpot(1);
}

function changeSpot(dir) {
  const newIndex = currentIndex + dir;
  if (newIndex < 0 || newIndex >= relatedSpots.length) return; // no loop for simplicity

  currentIndex = newIndex;

  // Re-render cards with new active/next/prev
  renderCards();
}
</script>
</body>
</html>
