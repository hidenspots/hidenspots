<!doctype html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-DWS0BB3H70"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-DWS0BB3H70');
  </script>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Spot • Hiden Spots</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0c0f18; --panel:#121624; --glass:rgba(255,255,255,.06);
      --border:rgba(255,255,255,.12); --muted:rgba(255,255,255,.78);
      --gold:#FFD88D; --amber:#FFB347; --teal:#19547b;
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0}
    body{
      background:var(--bg); color:#fff; font-family:'Playfair Display',serif;
    }
    /* Header */
    .header{
      position:sticky; top:0; z-index:40;
      backdrop-filter:blur(12px);
      background:linear-gradient(180deg,rgba(12,15,24,.85),rgba(12,15,24,.55));
      border-bottom:1px solid var(--border);
      padding:12px 18px;
      display:flex; align-items:center; gap:14px;
    }
    .brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:#fff}
    .brand svg{width:30px;height:30px}
    .brand span{letter-spacing:3px}
    /* Main Content */
    .main{
      max-width:800px;
      margin:0 auto;
      padding:20px;
    }
    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:16px;
      overflow:hidden;
      box-shadow:0 12px 26px rgba(0,0,0,.25);
    }
    /* HERO MEDIA */
    .hero-media {
      width: 100%;
      height: 400px;
      overflow: hidden;
      border-radius: 16px 16px 0 0;
    }
    .hero-media img,
    .hero-media video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    /* GALLERY THUMBNAILS */
    .gallery {
      display: flex;
      overflow-x: auto;
      gap: 8px;
      padding: 12px 0;
      scrollbar-width: thin;
      scrollbar-color: var(--gold) transparent;
    }
    .gallery::-webkit-scrollbar {
      height: 6px;
    }
    .gallery::-webkit-scrollbar-track {
      background: transparent;
    }
    .gallery::-webkit-scrollbar-thumb {
      background: var(--gold);
      border-radius: 3px;
    }
    .thumb {
      width: 80px;
      height: 80px;
      border-radius: 12px;
      overflow: hidden;
      cursor: pointer;
      flex-shrink: 0;
      border: 2px solid transparent;
      transition: border .3s;
    }
    .thumb.active {
      border-color: var(--gold);
    }
    .thumb img,
    .thumb video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    /* Info */
    .info{
      padding:20px;
    }
    .title{
      color:var(--gold);
      font-size:28px;
      margin:0 0 8px;
    }
    .sub{
      opacity:.85;
      font-size:18px;
      margin:0 0 16px;
    }
    .tags{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin:16px 0;
    }
    .tag{
      padding:6px 14px;
      border-radius:999px;
      background:rgba(255,255,255,.08);
      border:1px solid var(--border);
      font-size:14px;
      opacity:.9;
    }
    .story{
      font-size:16px;
      line-height:1.6;
      opacity:.95;
      margin:20px 0;
    }
    .details{
      margin-top:24px;
      display:grid;
      gap:16px;
      font-size:15px;
      opacity:.9;
    }
    .detail-item strong{
      color:var(--gold);
    }
    .user{
      display:flex;
      align-items:center;
      gap:12px;
      margin-top:24px;
      padding-top:20px;
      border-top:1px solid var(--border);
      opacity:.9;
    }
    .user .avatar{
      width:40px;
      height:40px;
      border-radius:50%;
      object-fit:cover;
      border:2px solid var(--gold);
    }
    .stars{
      color:#FFD88D;
      font-size:18px;
    }
    .stars span{
      opacity:0.3;
    }
    .stars span.filled{
      opacity:1;
    }
    .destiny-btn {
      margin-left: auto;
      padding: 8px 18px;
      border-radius: 999px;
      background: rgba(255,255,255,.1);
      border: 1px solid var(--border);
      font-size: 14px;
      cursor: pointer;
      transition: .3s;
    }
    .destiny-btn:hover {
      background: var(--gold);
      color: #000;
    }
    .destiny-btn.saved {
      background: var(--gold);
      color: #000;
    }
    /* Bottom Nav Bar */
    .nav-bar{
      background:rgba(255,255,255,.05);
      backdrop-filter:blur(25px);
      border-radius:60px;
      padding:1rem 2.5rem;
      border:1px solid rgba(255,255,255,.12);
      position:fixed;
      bottom:1rem;left:50%;transform:translateX(-50%);
      display:flex;gap:3rem;
      box-shadow:0 8px 30px rgba(0,0,0,.25);
      z-index:80;
    }
    .nav-icon{color:rgba(255,255,255,.7);transition:.4s}
    .nav-icon:hover{color:#FFD88D;transform:translateY(-2px);filter:drop-shadow(0 0 10px rgba(255,216,155,.6))}
    .nav-icon svg{width:24px;height:24px;stroke:currentColor;stroke-width:1.8;fill:none}
    @media(max-width:768px){
      .nav-bar{gap:2rem;padding:.9rem 1.6rem}
    }

    /* ────────────────────────────────────────────────
       NEW: Suggestions Section with Swipe + Buttons
    ──────────────────────────────────────────────── */
    .suggestions-section {
      padding: 3rem 1rem;
      background: #141824;
    }
    .suggestions-container {
      position: relative;
      max-width: 1000px;
      margin: 0 auto;
      overflow: hidden;
    }
    .suggestions-track {
      display: flex;
      gap: 1.5rem;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scroll-snap-type: x mandatory;
      padding: 0 1rem;
      scroll-behavior: smooth;
    }
    .suggestion-card {
      flex: 0 0 280px;
      background: #121624;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
      cursor: pointer;
      transition: transform 0.3s, box-shadow 0.3s;
      scroll-snap-align: start;
    }
    .suggestion-card:hover {
      transform: scale(1.05);
      box-shadow: 0 12px 32px rgba(255,216,141,0.3);
    }
    .suggestion-card img {
      width: 100%;
      height: 180px;
      object-fit: cover;
    }
    .suggestion-card .info {
      padding: 1rem;
    }
    .suggestion-card h3 {
      margin: 0;
      font-size: 1.2rem;
      color: #FFD88D;
    }
    .suggestion-card p {
      margin: 0.5rem 0 0;
      opacity: 0.8;
      font-size: 0.95rem;
    }
    /* Swipe Buttons */
    .swipe-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0,0,0,0.5);
      color: #FFD88D;
      border: none;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      font-size: 1.8rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      transition: background 0.3s;
    }
    .swipe-btn:hover {
      background: rgba(255,216,141,0.3);
    }
    .swipe-btn.prev {
      left: 10px;
    }
    .swipe-btn.next {
      right: 10px;
    }
    @media (max-width: 768px) {
      .swipe-btn {
        width: 44px;
        height: 44px;
        font-size: 1.5rem;
      }
    }
  </style>
</head>
<body>
<div class="header">
  <a href="index.html" class="brand" aria-label="Hiden Spots">
    <svg viewBox="0 0 48 48" aria-hidden="true">
      <circle cx="24" cy="24" r="21" stroke="rgba(255,255,255,0.85)" stroke-width="1.5"/>
      <path d="M24 10 L28 24 L24 38 L20 24 Z" fill="rgba(255,216,155,0.9)"/>
      <circle cx="24" cy="24" r="2.6" fill="#ffffff"/>
    </svg>
    <span>Hiden Spots</span>
  </a>
</div>
<div class="main">
  <article class="card" id="spotCard">
    <div class="hero-media" id="heroMedia"></div>
    <div class="gallery" id="gallery"></div>
    <div class="info">
      <h1 class="title" id="title"></h1>
      <p class="sub" id="sub"></p>
      <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
        <div class="tags" id="tags"></div>
        <button class="destiny-btn" id="destinyBtn">Add to Destiny</button>
      </div>
      <div class="story" id="story"></div>
      <div class="details">
        <div class="detail-item"><strong>Solo Woman Safety Rating:</strong> <span id="safety"></span></div>
        <div class="detail-item"><strong>Best Time:</strong> <span id="besttime"></span></div>
        <div class="detail-item"><strong>Tips:</strong> <span id="tips"></span></div>
        <div class="detail-item"><strong>Hashtags:</strong> <span id="hashtags"></span></div>
        <div class="detail-item"><strong>Credits:</strong> <span id="credits"></span></div>
      </div>
      <div class="user" style="cursor:pointer;" onclick="goToProfile()">
        <img class="avatar" id="userAvatar" src="">
        <span>Posted by <span id="username" style="color:var(--gold);"></span></span>
      </div>
    </div>
  </article>

  <!-- Swipeable Suggestions Section -->
  <section class="suggestions-section">
    <h2 style="text-align:center; color:#FFD88D; font-size:2rem; margin-bottom:2rem;">More Hidden Spots Like This</h2>
    <div class="suggestions-container">
      <button class="swipe-btn prev" id="prevBtn">←</button>
      <div class="suggestions-track" id="suggestionsTrack"></div>
      <button class="swipe-btn next" id="nextBtn">→</button>
    </div>
    <div style="text-align:center; margin-top:1.5rem; opacity:0.7; font-size:0.95rem;">
      Swipe left/right or use arrows
    </div>
  </section>
</div>

<!-- Bottom Navigation Bar -->
<nav class="nav-bar" aria-label="Primary">
  <a href="Mainhome.html" class="nav-icon" title="Home">
    <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
  </a>
  <a href="Home.html" class="nav-icon" title="Search">
    <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
  </a>
  <a href="Upload.html" class="nav-icon" title="Create">
    <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
  </a>
  <a href="Explore.html" class="nav-icon" title="Destiny List">
    <svg viewBox="0 0 24 24">
      <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/>
      <circle cx="12" cy="9" r="2.5" fill="none"/>
      <path d="M12 6l.9 1.8 2 .3-1.5 1.5.35 2.1L12 11l-1.75.7.35-2.1-1.5-1.5 2-.3L12 6z" fill="currentColor"/>
    </svg>
  </a>
  <a href="Profile.html" class="nav-icon" title="Profile">
    <svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
  </a>
</nav>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const sb = supabase.createClient(
  "https://bhktkjegansxplpdtack.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJoa3RramVnYW5zeHBscGR0YWNrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2OTE2NjQsImV4cCI6MjA4MTI2NzY2NH0.WlQTPkC6WBjaK_Guy0_XPGahR9oNYsbIHdaBn4WQspE"
);
const WORKER_URL = 'https://hiden-spots-r2-proxy.whynot555x7.workers.dev';
  let spot = null; // ← Add this line right after const WORKER_URL = ...
const urlParams = new URLSearchParams(window.location.search);
const spotId = urlParams.get('id');
if (!spotId) {
  document.body.innerHTML = '<h1 style="text-align:center;margin-top:100px;">No spot selected</h1>';
} else {
  loadSpot(spotId);
}
async function loadSpot(id) {
  const { data: spot, error } = await sb
    .from('spots')
    .select('*')
    .eq('id', id)
    .single();
  if (error || !spot) {
    document.body.innerHTML = '<h1 style="text-align:center;margin-top:100px;">Spot not found</h1>';
    return;
  }
  spot = data;
  const categoryNames = {1:'Adventure',2:'Spiritual',3:'Historical',4:'Horror',5:'Solo',6:'Family',7:'Restaurant'};
  const emotionNames = {1:'Peaceful',2:'Long Drive',3:'Romantic',4:'Spiritual',5:'Lonely',6:'Broken',7:'Relaxation',8:'Energetic'};
  let mediaList = [];
  if (spot.media_urls && Array.isArray(spot.media_urls)) {
    mediaList = spot.media_urls;
  } else if (spot.media_url) {
    mediaList = [{ url: spot.media_url, type: 'image' }];
  }
  if (mediaList.length > 0) {
    const first = mediaList[0];
    const heroEl = document.getElementById('heroMedia');
    if (first.type === 'video') {
      heroEl.innerHTML = `<video src="${first.url}" controls autoplay loop muted playsinline style="width:100%;height:100%;object-fit:cover;"></video>`;
    } else {
      heroEl.innerHTML = `<img src="${first.url}" alt="${spot.name}" style="width:100%;height:100%;object-fit:cover;" onerror="this.src='https://via.placeholder.com/800x400/141824/FFD88D?text=No+Image'">`;
    }
  }
  const gallery = document.getElementById('gallery');
  gallery.innerHTML = '';
  if (mediaList.length > 1) {
    mediaList.forEach((media, index) => {
      const thumb = document.createElement('div');
      thumb.className = 'thumb' + (index === 0 ? ' active' : '');
      if (media.type === 'video') {
        thumb.innerHTML = `<video src="${media.url}" muted playsinline style="width:100%;height:100%;object-fit:cover;"></video>`;
      } else {
        thumb.innerHTML = `<img src="${media.url}" alt="thumb" style="width:100%;height:100%;object-fit:cover;" onerror="this.src='https://via.placeholder.com/80/141824/FFD88D?text=No+Image'">`;
      }
      thumb.onclick = () => {
        const heroEl = document.getElementById('heroMedia');
        if (media.type === 'video') {
          heroEl.innerHTML = `<video src="${media.url}" controls autoplay loop muted playsinline style="width:100%;height:100%;object-fit:cover;"></video>`;
        } else {
          heroEl.innerHTML = `<img src="${media.url}" alt="${spot.name}" style="width:100%;height:100%;object-fit:cover;" onerror="this.src='https://via.placeholder.com/800x400/141824/FFD88D?text=No+Image'">`;
        }
        document.querySelectorAll('.thumb').forEach(t => t.classList.remove('active'));
        thumb.classList.add('active');
      };
      gallery.appendChild(thumb);
    });
  }
  document.getElementById('title').textContent = spot.name;
  document.getElementById('sub').textContent = `${spot.place}, ${spot.city}${spot.state ? ', ' + spot.state : ''}, ${spot.country}`;
  document.getElementById('tags').innerHTML = `
    <span class="tag">${categoryNames[spot.category_id] || 'Other'}</span>
    <span class="tag">${emotionNames[spot.emotion_id] || ''}</span>
  `;
  document.getElementById('story').textContent = spot.story || 'No story shared.';
  const rating = spot.safety_rating || 0;
  const starsHtml = '★'.repeat(rating) + '☆'.repeat(5 - rating);
  document.getElementById('safety').innerHTML = `<span class="stars">${starsHtml.replace(/★/g, '<span class="filled">★</span>')}</span>`;
  document.getElementById('besttime').textContent = spot.best_time || '-';
  document.getElementById('tips').textContent = spot.tips || '-';
  document.getElementById('hashtags').textContent = spot.hashtags || '-';
  document.getElementById('credits').textContent = spot.credits || '-';
  const username = spot.username || 'traveller';
  document.getElementById('username').textContent = `@${username}`;
  const avatarUrl = `${WORKER_URL}/file/avatars/${username}-avatar.jpg`;
  const fallbackAvatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(username)}&background=FFD88D&color=0c0f18&size=120`;
  const avatarImg = document.getElementById('userAvatar');
  avatarImg.src = avatarUrl;
  avatarImg.onerror = () => { avatarImg.src = fallbackAvatar; };
  document.querySelector('.user').onclick = () => {
    window.location.href = `Profile.html?user=${username}`;
  };
  setupDestinyButton(spot.id);

  // Load suggestions
  loadRelatedSpots();
}

async function setupDestinyButton(spotId) {
  const { data: { user } } = await sb.auth.getUser();
  const btn = document.getElementById('destinyBtn');
  if (!user) {
    btn.textContent = 'Login to Save';
    btn.disabled = true;
    return;
  }
  const { data: existing } = await sb
    .from('destiny_saves')
    .select('id')
    .eq('user_id', user.id)
    .eq('spot_id', spotId)
    .maybeSingle();
  const isSaved = !!existing;
  btn.textContent = isSaved ? 'Saved ❤️' : 'Add to Destiny';
  if (isSaved) btn.classList.add('saved');
  btn.onclick = async () => {
    if (isSaved) {
      await sb.from('destiny_saves').delete().eq('id', existing.id);
      btn.textContent = 'Add to Destiny';
      btn.classList.remove('saved');
    } else {
      await sb.from('destiny_saves').insert({ user_id: user.id, spot_id: spotId });
      btn.textContent = 'Saved ❤️';
      btn.classList.add('saved');
    }
  };
}

// ────────────────────────────────────────────────
// Load unlimited related spots + swipe + buttons
// ────────────────────────────────────────────────
async function loadRelatedSpots() {
  if (!spot || !spot.category_id || !spot.emotion_id || !spot.city) return;

  const track = document.getElementById('suggestionsTrack');
  if (!track) return;

  track.innerHTML = '<p style="text-align:center; width:100%; padding:2rem; opacity:0.7;">Loading similar spots...</p>';

  const { data: related, error } = await sb
    .from('spots')
    .select('id, name, place, city, media_url, media_urls')
    .neq('id', spot.id)
    .or(`category_id.eq.${spot.category_id},emotion_id.eq.${spot.emotion_id},city.eq.${spot.city}`);

  if (error || !related || related.length === 0) {
    track.innerHTML = '<p style="text-align:center; width:100%; padding:2rem; opacity:0.7;">No similar spots found yet</p>';
    return;
  }

  track.innerHTML = '';

  related.forEach(r => {
    const firstMedia = r.media_urls?.[0]?.url || r.media_url || 'https://via.placeholder.com/300x200/141824/FFD88D?text=No+Image';

    const card = document.createElement('div');
    card.className = 'suggestion-card';
    card.innerHTML = `
      <img src="${firstMedia}" alt="${r.name}" onerror="this.src='https://via.placeholder.com/300x200/141824/FFD88D?text=No+Image'">
      <div style="padding:1rem;">
        <h3 style="margin:0;font-size:1.2rem;color:#FFD88D;">${r.name}</h3>
        <p style="margin:0.5rem 0 0;opacity:0.8;font-size:0.95rem;">${r.place || ''}, ${r.city}</p>
      </div>
    `;

    card.onclick = () => {
      window.location.href = `spot.html?id=${r.id}`;
    };

    track.appendChild(card);
  });

  // ────────────────────────────────────────────────
  // FIXED SWIPE + ARROW BUTTONS
  // ────────────────────────────────────────────────
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');

  // Scroll amount per click (adjust if needed)
  const scrollAmount = 300;

  prevBtn.addEventListener('click', () => {
    track.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
  });

  nextBtn.addEventListener('click', () => {
    track.scrollBy({ left: scrollAmount, behavior: 'smooth' });
  });

  // Mouse drag
  let isDown = false;
  let startX;
  let scrollLeft;

  track.addEventListener('mousedown', (e) => {
    isDown = true;
    startX = e.pageX - track.offsetLeft;
    scrollLeft = track.scrollLeft;
    track.style.cursor = 'grabbing';
  });

  track.addEventListener('mouseleave', () => {
    isDown = false;
    track.style.cursor = 'grab';
  });

  track.addEventListener('mouseup', () => {
    isDown = false;
    track.style.cursor = 'grab';
  });

  track.addEventListener('mousemove', (e) => {
    if (!isDown) return;
    e.preventDefault();
    const x = e.pageX - track.offsetLeft;
    const walk = (x - startX) * 2;
    track.scrollLeft = scrollLeft - walk;
  });

  // Touch swipe (mobile)
  track.addEventListener('touchstart', (e) => {
    isDown = true;
    startX = e.touches[0].pageX - track.offsetLeft;
    scrollLeft = track.scrollLeft;
  }, { passive: false });

  track.addEventListener('touchend', () => {
    isDown = false;
  }, { passive: false });

  track.addEventListener('touchmove', (e) => {
    if (!isDown) return;
    const x = e.touches[0].pageX - track.offsetLeft;
    const walk = (x - startX) * 2;
    track.scrollLeft = scrollLeft - walk;
  }, { passive: false });
}
</script>
</body>
</html>

